<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coin Metrics API Test - MVRV Data</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
    }
    code {
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .metric-card {
      display: inline-block;
      background: #fff;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      padding: 15px 20px;
      margin: 10px;
      min-width: 200px;
    }
    .metric-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>üß™ Coin Metrics Community API - Live Test</h1>

  <div class="test-section">
    <h2>Test 1: Fetch Last 7 Days</h2>
    <p>This test fetches the most recent 7 days of Bitcoin Market Cap and Realized Cap data.</p>
    <button onclick="testRecentData()">Run Test 1</button>
    <div id="test1-status"></div>
    <div id="test1-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Calculate MVRV Ratio</h2>
    <p>This test calculates the MVRV ratio (Market Cap / Realized Cap) from the fetched data.</p>
    <button onclick="testMVRVCalculation()">Run Test 2</button>
    <div id="test2-status"></div>
    <div id="test2-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Fetch Historical Data (730 days)</h2>
    <p>This test fetches 730 days of data needed for 2-year rolling window calculation.</p>
    <button onclick="testHistoricalData()">Run Test 3</button>
    <div id="test3-status"></div>
    <div id="test3-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Calculate 2YR Rolling Z-Score</h2>
    <p>This test calculates a sample 2-year rolling Z-Score using 730 days of data.</p>
    <button onclick="testZScoreCalculation()">Run Test 4</button>
    <div id="test4-status"></div>
    <div id="test4-results"></div>
  </div>

  <script>
    const API_BASE = 'https://community-api.coinmetrics.io/v4';

    function showStatus(elementId, type, message) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function showResults(elementId, content) {
      const el = document.getElementById(elementId);
      el.innerHTML = content;
    }

    async function testRecentData() {
      showStatus('test1-status', 'info', '‚è≥ Fetching data from Coin Metrics...');
      showResults('test1-results', '');

      try {
        const daysAgo = 7;
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - daysAgo);
        const startTime = startDate.toISOString().split('T')[0];

        const url = `${API_BASE}/timeseries/asset-metrics?assets=btc&metrics=CapRealUSD,CapMrktCurUSD&frequency=1d&start_time=${startTime}&format=json`;

        console.log('Fetching:', url);

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

        const data = await response.json();

        if (!data.data || data.data.length === 0) {
          throw new Error('No data returned from API');
        }

        showStatus('test1-status', 'success', `‚úÖ Success! Fetched ${data.data.length} days of data`);

        // Display latest values
        const latest = data.data[data.data.length - 1];
        const marketCap = parseFloat(latest.CapMrktCurUSD);
        const realizedCap = parseFloat(latest.CapRealUSD);

        const resultsHTML = `
          <div style="margin: 20px 0;">
            <div class="metric-card">
              <div class="metric-label">Latest Date</div>
              <div class="metric-value">${latest.time.split('T')[0]}</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Market Cap</div>
              <div class="metric-value">$${(marketCap / 1e9).toFixed(2)}B</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Realized Cap</div>
              <div class="metric-value">$${(realizedCap / 1e9).toFixed(2)}B</div>
            </div>
          </div>
          <h3>Raw API Response (Last 3 Days):</h3>
          <pre><code>${JSON.stringify(data.data.slice(-3), null, 2)}</code></pre>
        `;

        showResults('test1-results', resultsHTML);

      } catch (error) {
        showStatus('test1-status', 'error', `‚ùå Error: ${error.message}`);
        console.error('Test 1 Error:', error);
      }
    }

    async function testMVRVCalculation() {
      showStatus('test2-status', 'info', '‚è≥ Fetching and calculating MVRV...');
      showResults('test2-results', '');

      try {
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        const startTime = startDate.toISOString().split('T')[0];

        const url = `${API_BASE}/timeseries/asset-metrics?assets=btc&metrics=CapRealUSD,CapMrktCurUSD&frequency=1d&start_time=${startTime}&format=json`;

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        // Calculate MVRV for all dates
        const mvrvData = data.data.map(d => {
          const marketCap = parseFloat(d.CapMrktCurUSD);
          const realizedCap = parseFloat(d.CapRealUSD);
          const mvrv = marketCap / realizedCap;

          return {
            date: d.time.split('T')[0],
            mvrv: mvrv.toFixed(4),
            marketCap: (marketCap / 1e9).toFixed(2),
            realizedCap: (realizedCap / 1e9).toFixed(2)
          };
        });

        const latest = mvrvData[mvrvData.length - 1];

        showStatus('test2-status', 'success', `‚úÖ MVRV calculated for ${mvrvData.length} days`);

        const resultsHTML = `
          <div style="margin: 20px 0;">
            <div class="metric-card">
              <div class="metric-label">Current MVRV Ratio</div>
              <div class="metric-value">${latest.mvrv}</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Interpretation</div>
              <div class="metric-value">${parseFloat(latest.mvrv) > 1 ? 'üìà Above Fair Value' : 'üìâ Below Fair Value'}</div>
            </div>
          </div>
          <h3>Last 7 Days MVRV:</h3>
          <pre><code>${JSON.stringify(mvrvData.slice(-7), null, 2)}</code></pre>
        `;

        showResults('test2-results', resultsHTML);

      } catch (error) {
        showStatus('test2-status', 'error', `‚ùå Error: ${error.message}`);
        console.error('Test 2 Error:', error);
      }
    }

    async function testHistoricalData() {
      showStatus('test3-status', 'info', '‚è≥ Fetching 730 days of historical data (this may take a moment)...');
      showResults('test3-results', '');

      try {
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 730);
        const startTime = startDate.toISOString().split('T')[0];

        const url = `${API_BASE}/timeseries/asset-metrics?assets=btc&metrics=CapRealUSD,CapMrktCurUSD&frequency=1d&start_time=${startTime}&format=json`;

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        showStatus('test3-status', 'success', `‚úÖ Successfully fetched ${data.data.length} days of historical data`);

        const firstDate = data.data[0].time.split('T')[0];
        const lastDate = data.data[data.data.length - 1].time.split('T')[0];

        const resultsHTML = `
          <div style="margin: 20px 0;">
            <div class="metric-card">
              <div class="metric-label">Total Days</div>
              <div class="metric-value">${data.data.length}</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Date Range</div>
              <div class="metric-value">${firstDate} to ${lastDate}</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Ready for Z-Score</div>
              <div class="metric-value">${data.data.length >= 730 ? '‚úÖ YES' : '‚ùå NO'}</div>
            </div>
          </div>
          <p><strong>Note:</strong> This is exactly the data we need for calculating a 2-year rolling Z-Score window!</p>
        `;

        showResults('test3-results', resultsHTML);

      } catch (error) {
        showStatus('test3-status', 'error', `‚ùå Error: ${error.message}`);
        console.error('Test 3 Error:', error);
      }
    }

    async function testZScoreCalculation() {
      showStatus('test4-status', 'info', '‚è≥ Calculating 2-year rolling Z-Score...');
      showResults('test4-results', '');

      try {
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 730);
        const startTime = startDate.toISOString().split('T')[0];

        const url = `${API_BASE}/timeseries/asset-metrics?assets=btc&metrics=CapRealUSD,CapMrktCurUSD&frequency=1d&start_time=${startTime}&format=json`;

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        // Calculate MVRV for all dates
        const mvrvValues = data.data.map(d =>
          parseFloat(d.CapMrktCurUSD) / parseFloat(d.CapRealUSD)
        );

        // Calculate 730-day rolling Z-Score (just for the latest value)
        if (mvrvValues.length < 730) {
          throw new Error('Need at least 730 days of data');
        }

        const last730 = mvrvValues.slice(-730);
        const mean = last730.reduce((a, b) => a + b) / 730;
        const variance = last730.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / 730;
        const stddev = Math.sqrt(variance);
        const zscore = (mvrvValues[mvrvValues.length - 1] - mean) / stddev;

        showStatus('test4-status', 'success', '‚úÖ 2-Year Rolling Z-Score calculated successfully!');

        let interpretation = '';
        if (zscore > 7) interpretation = 'üî¥ Extremely Overvalued (Historic Top)';
        else if (zscore > 3) interpretation = 'üü† Overvalued';
        else if (zscore > 0) interpretation = 'üü° Above Mean';
        else if (zscore > -0.5) interpretation = 'üü¢ Below Mean';
        else interpretation = 'üü¢ Undervalued (Potential Bottom)';

        const resultsHTML = `
          <div style="margin: 20px 0;">
            <div class="metric-card">
              <div class="metric-label">2YR Rolling Z-Score</div>
              <div class="metric-value">${zscore.toFixed(4)}</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Rolling Window</div>
              <div class="metric-value">730 Days</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Interpretation</div>
              <div class="metric-value" style="font-size: 18px;">${interpretation}</div>
            </div>
          </div>
          <h3>Calculation Details:</h3>
          <pre><code>{
  "windowSize": 730,
  "currentMVRV": ${mvrvValues[mvrvValues.length - 1].toFixed(4)},
  "rolling730DayMean": ${mean.toFixed(4)},
  "rolling730DayStdDev": ${stddev.toFixed(4)},
  "zScore": ${zscore.toFixed(4)},
  "formula": "(currentMVRV - mean) / stddev"
}</code></pre>
          <p><strong>‚úÖ SUCCESS!</strong> This proves we can calculate the 2-year rolling Z-Score using free Coin Metrics data.</p>
        `;

        showResults('test4-results', resultsHTML);

      } catch (error) {
        showStatus('test4-status', 'error', `‚ùå Error: ${error.message}`);
        console.error('Test 4 Error:', error);
      }
    }
  </script>
</body>
</html>
